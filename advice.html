<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Advice System</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2>Welcome, <span id="userName"></span>!</h2>

    <!-- Advice Submission -->
    <textarea id="adviceInput" placeholder="Enter your advice or concern..."></textarea>
    <button id="submitAdvice">Submit Advice</button>
    <p id="status"></p>

    <!-- Admin View -->
    <div id="adminPanel" style="display:none;">
      <h3>All Conversations</h3>
      <div id="adminAdviceList"></div>
    </div>

    <!-- User View -->
    <div id="userPanel">
      <h3>Your Conversation</h3>
      <div id="userAdviceList"></div>
    </div>

    <button id="logoutBtn">Logout</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiNKDXds9IWjFAwSbJaNN8Zd37Wujk5Kc",
      authDomain: "grid-walker-project.firebaseapp.com",
      projectId: "grid-walker-project",
      appId: "grid walker project"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const adminEmail = "admin@example.com"; // replace with your actual admin email

    const userNameSpan = document.getElementById("userName");
    const adviceInput = document.getElementById("adviceInput");
    const submitBtn = document.getElementById("submitAdvice");
    const logoutBtn = document.getElementById("logoutBtn");
    const statusText = document.getElementById("status");

    const adminPanel = document.getElementById("adminPanel");
    const adminAdviceList = document.getElementById("adminAdviceList");
    const userPanel = document.getElementById("userPanel");
    const userAdviceList = document.getElementById("userAdviceList");

    let currentUser;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "login.html";
      currentUser = user;
      userNameSpan.textContent = user.email;

      if (user.email === adminEmail) {
        adminPanel.style.display = "block";
        userPanel.style.display = "none";
        loadAllAdvice();
      } else {
        adminPanel.style.display = "none";
        userPanel.style.display = "block";
        loadUserAdvice();
      }
    });

    submitBtn.onclick = async () => {
      const message = adviceInput.value.trim();
      if (!message) return;

      try {
        await addDoc(collection(db, "advices"), {
          userEmail: currentUser.email,
          thread: [
            {
              sender: "user",
              message,
              timestamp: new Date().toISOString()
            }
          ],
          timestamp: serverTimestamp()
        });
        statusText.textContent = "✅ Advice submitted!";
        adviceInput.value = "";
        loadUserAdvice();
      } catch (e) {
        statusText.textContent = "❌ Failed to submit.";
      }
    };

    async function loadAllAdvice() {
      const q = query(collection(db, "advices"));
      const snapshot = await getDocs(q);
      adminAdviceList.innerHTML = "";

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.classList.add("feedback-item");

        const messages = (data.thread || []).map(m => `<p><strong>${m.sender}:</strong> ${m.message}</p>`).join("");

        div.innerHTML = `
          <strong>${data.userEmail}</strong><br>
          ${messages}
          <textarea placeholder="Reply..."></textarea>
          <button class="reply">Send Reply</button>
          <button class="delete" style="margin-left: 10px;">Delete Advice</button>
        `;

        const replyBtn = div.querySelector(".reply");
        const deleteBtn = div.querySelector(".delete");
        const replyInput = div.querySelector("textarea");

        replyBtn.onclick = async () => {
          const newReply = {
            sender: "admin",
            message: replyInput.value.trim(),
            timestamp: new Date().toISOString()
          };
          const updatedThread = [...(data.thread || []), newReply];
          await updateDoc(doc(db, "advices", docSnap.id), { thread: updatedThread });
          loadAllAdvice();
        };

        deleteBtn.onclick = async () => {
          if (confirm("Are you sure you want to delete this advice?")) {
            await deleteDoc(doc(db, "advices", docSnap.id));
            loadAllAdvice();
          }
        };

        adminAdviceList.appendChild(div);
      });
    }

    async function loadUserAdvice() {
      const q = query(collection(db, "advices"), where("userEmail", "==", currentUser.email));
      const snapshot = await getDocs(q);
      userAdviceList.innerHTML = "";

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.classList.add("feedback-item");

        const messages = (data.thread || []).map(m => `<p><strong>${m.sender}:</strong> ${m.message}</p>`).join("");

        div.innerHTML = `
          ${messages}
          <textarea placeholder="Reply..."></textarea>
          <button>Reply</button>
        `;

        const replyBtn = div.querySelector("button");
        const replyInput = div.querySelector("textarea");

        replyBtn.onclick = async () => {
          const newReply = {
            sender: "user",
            message: replyInput.value.trim(),
            timestamp: new Date().toISOString()
          };
          const updatedThread = [...(data.thread || []), newReply];
          await updateDoc(doc(db, "advices", docSnap.id), { thread: updatedThread });
          loadUserAdvice();
        };

        userAdviceList.appendChild(div);
      });
    }

    logoutBtn.onclick = () => signOut(auth);
  </script>
</body>
</html>
