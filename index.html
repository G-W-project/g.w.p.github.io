<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat Room</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2>Welcome, <span id="userName"></span>!</h2>

    <!-- Profile Image -->
    <img id="profileImage" src="" alt="Profile Image" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;" />
    <input type="file" id="profileInput" accept="image/*" />
    <button id="uploadBtn">Change Photo</button>

    <!-- Chat -->
    <textarea id="messageInput" placeholder="Type your message..."></textarea>
    <button id="sendMessage">Send</button>
    <div id="messages"></div>

    <!-- Add Friend -->
    <hr />
    <input type="email" id="friendEmail" placeholder="Add friend by email" />
    <button id="addFriendBtn">Add Friend</button>
    <p id="friendMsg"></p>
    <h3>Your Friends</h3>
    <ul id="friendList"></ul>

    <button id="logoutBtn">Logout</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiNKDXds9IWjFAwSbJaNN8Zd37Wujk5Kc",
      authDomain: "grid-walker-project.firebaseapp.com",
      projectId: "grid-walker-project",
      appId: "grid walker project"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUser = null;
    let currentUsername = "";

    const userNameEl = document.getElementById("userName");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendMessage");
    const messageBox = document.getElementById("messages");
    const logoutBtn = document.getElementById("logoutBtn");
    const profileImage = document.getElementById("profileImage");
    const profileInput = document.getElementById("profileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const friendInput = document.getElementById("friendEmail");
    const friendMsg = document.getElementById("friendMsg");
    const friendList = document.getElementById("friendList");
    const addFriendBtn = document.getElementById("addFriendBtn");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      currentUser = user;
      const userDocRef = doc(db, "users", user.email);
      const userDocSnap = await getDoc(userDocRef);

      if (userDocSnap.exists()) {
        const data = userDocSnap.data();
        currentUsername = data.username || user.email;
        userNameEl.textContent = currentUsername;
        if (data.photoURL) {
          profileImage.src = data.photoURL;
        } else {
          profileImage.src = "https://via.placeholder.com/100?text=No+Photo";
        }
      } else {
        profileImage.src = "https://via.placeholder.com/100?text=No+Photo";
        userNameEl.textContent = user.email;
      }

      loadMessages();
      loadFriends();
    });

    uploadBtn.onclick = async () => {
      const file = profileInput.files[0];
      if (!file) return alert("Select an image.");

      const storageRef = ref(storage, `profile_pics/${currentUser.email}`);
      await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(storageRef);

      await setDoc(doc(db, "users", currentUser.email), {
        photoURL: downloadURL
      }, { merge: true });

      profileImage.src = downloadURL;
      alert("✅ Photo updated!");
    };

    sendBtn.onclick = async () => {
      const text = messageInput.value.trim();
      if (!text) return;
      await addDoc(collection(db, "messages"), {
        user: currentUser.email,
        username: currentUsername,
        message: text,
        timestamp: Date.now()
      });
      messageInput.value = "";
      loadMessages();
    };

    async function loadMessages() {
      const messages = await getDocs(collection(db, "messages"));
      const sorted = [];
      messages.forEach(doc => sorted.push(doc.data()));
      sorted.sort((a, b) => b.timestamp - a.timestamp);
      messageBox.innerHTML = sorted.map(m =>
        `<div class="feedback-item"><strong>@${m.username}:</strong><br>${m.message}</div>`
      ).join("");
    }

    logoutBtn.onclick = () => signOut(auth);

    addFriendBtn.onclick = async () => {
      const friendEmail = friendInput.value.trim().toLowerCase();
      if (!friendEmail || friendEmail === currentUser.email) {
        friendMsg.textContent = "❌ Invalid email.";
        return;
      }

      const userDoc = await getDoc(doc(db, "users", friendEmail));
      if (!userDoc.exists()) {
        friendMsg.textContent = "❌ User not found.";
        return;
      }

      const myFriendListRef = doc(db, "friends", currentUser.email);
      const existing = await getDoc(myFriendListRef);
      const friendData = existing.exists() ? existing.data() : {};

      if (friendData[friendEmail]) {
        friendMsg.textContent = "⚠️ Already added.";
        return;
      }

      await setDoc(myFriendListRef, {
        ...friendData,
        [friendEmail]: true
      });

      friendMsg.textContent = "✅ Friend added!";
      friendInput.value = "";
      loadFriends();
    };

    async function loadFriends() {
      const docRef = doc(db, "friends", currentUser.email);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) {
        friendList.innerHTML = "<li>No friends yet.</li>";
        return;
      }

      const friendEmails = Object.keys(docSnap.data());
      const listItems = await Promise.all(friendEmails.map(async (email) => {
        const userDoc = await getDoc(doc(db, "users", email));
        const data = userDoc.data();
        const username = data?.username || email;
        const photoURL = data?.photoURL || "https://via.placeholder.com/50?text=No+Pic";
        return `<li><img src="${photoURL}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right: 8px;" /> @${username}</li>`;
      }));

      friendList.innerHTML = listItems.join("");
    }
  </script>
</body>
</html>
